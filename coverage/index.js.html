<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for index.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> index.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>79/79</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.3% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>42/46</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>17/17</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>75/75</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">61x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">52x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">43x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-yes">176x</span>
<span class="cline-any cline-yes">176x</span>
<span class="cline-any cline-yes">176x</span>
<span class="cline-any cline-yes">176x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">193x</span>
<span class="cline-any cline-yes">123x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">193x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">29x</span>
<span class="cline-any cline-yes">29x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">49x</span>
<span class="cline-any cline-yes">49x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">47x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const OPEN = 0
const HALF_OPEN = 1
const CLOSED = 2
&nbsp;
const createBucket = () =&gt; ({
  failures: 0,
  successes: 0,
  timeouts: 0,
  shortCircuits: 0
})
&nbsp;
const createState = (opts = <span class="branch-0 cbranch-no" title="branch not covered" >{})</span> =&gt; {
  let s = CLOSED
  // open 的标准
  const { errorThreshold, volumeThreshold, onClosed, onOpen } = opts
&nbsp;
  return {
    isOpen () {
      return s === OPEN
    },
    // OPEN -&gt; HALF_OPEN
    openHalf () {
      this.updateState(HALF_OPEN)
    },
    getState () {
      return s
    },
    // HALF_OPEN -&gt; OPEN/CLOSED  CLOSED -&gt; OPEN  OPEN -&gt; HALF_OPEN
    updateState (buckets) {
      // OPEN -&gt; HALF_OPEN
      if (s === OPEN &amp;&amp; buckets === HALF_OPEN) {
        s = HALF_OPEN
        return
      }
      const metrics = calculateMetrics(buckets)
&nbsp;
      // HALF_OPEN -&gt; OPEN/CLOSED
      if (s === HALF_OPEN) {
        // 最后一个 bucket 是否失败: 没有成功且有失败，则为失败。只要有成功就算成功
        const lastCommandFailed = !buckets[buckets.length - 1].successes &amp;&amp; metrics.errorCount &gt; 0
&nbsp;
        if (lastCommandFailed) {
          s = OPEN
        } else {
          s = CLOSED
          // 触发关闭回调
          onClosed &amp;&amp; onClosed(metrics)
        }
      } else if (s === CLOSED) {
        // CLOSED -&gt; OPEN
        // 超过 error 阈值
        const overErrorThreshold = metrics.getErrorPercentage() &gt; errorThreshold
        // 超过指定请求数
        const overVolumeThreshold = metrics.totalCount &gt; volumeThreshold
        // 只有超过指定请求数，error 阈值才有意义
        const overThreshold = overVolumeThreshold &amp;&amp; overErrorThreshold
&nbsp;
        if (overThreshold) {
          s = OPEN
          setTimeout(() =&gt; {
            this.isOpen() &amp;&amp; this.openHalf()
          }, opts.windowDuration)
          // 触发开启回调
          onOpen &amp;&amp; onOpen(metrics)
        }
      }
    }
  }
}
&nbsp;
const calculateMetrics = buckets =&gt; buckets.reduce((result, bucket) =&gt; {
  const errors = bucket.failures + bucket.timeouts
  result.errorCount += errors
  result.totalCount += (errors + bucket.successes)
  return result
}, {
  totalCount: 0,
  errorCount: 0,
  getErrorPercentage () {
    return (this.errorCount / (this.totalCount &gt; 0 ? this.totalCount : <span class="branch-1 cbranch-no" title="branch not covered" >1)</span>) * 100
  }
})
&nbsp;
const startTicker = (buckets = <span class="branch-0 cbranch-no" title="branch not covered" >[],</span> opts = <span class="branch-0 cbranch-no" title="branch not covered" >{})</span> =&gt; {
  const bucketDuration = opts.windowDuration / opts.numBuckets
  return setInterval(() =&gt; {
    if (buckets.length &gt; opts.numBuckets) {
      buckets.shift()
    }
    // 每 bucketDuration ms 一个 bucket
    buckets.push(createBucket())
  }, bucketDuration)
}
&nbsp;
const stateExecuteCommand = (s, timeoutDuration) =&gt; (command, buckets) =&gt; {
  const increment = prop =&gt; {
    buckets[buckets.length - 1][prop]++
    s.updateState(buckets)
  }
  const commandPromise = command()
  const timeoutPromise = new Promise(resolve =&gt; {
    setTimeout(() =&gt; resolve('request timeout'), timeoutDuration)
  })
&nbsp;
  // command 和 timeout 竞争
  return Promise.race([
    commandPromise,
    timeoutPromise
  ]).then(data =&gt; {
    if (data === 'request timeout') {
      // 记录超时情况，成功或者失败的情况在超时时间之内返回，则不记录超时
      increment('timeouts')
      return commandPromise
    }
    // 记录成功
    increment('successes')
    return data
  }).catch(error =&gt; {
    // 记录失败
    increment('failures')
    return Promise.reject(error)
  })
}
&nbsp;
class Hystrix {
  constructor (opts = {}) {
    this.opts = opts
    // 初始化
    this.opts.windowDuration = opts.windowDuration || 10000 // ms
    this.opts.numBuckets = opts.numBuckets || 10 // number
    this.opts.timeoutDuration = opts.timeoutDuration || 3000 // ms
    this.opts.errorThreshold = opts.errorThreshold || 50 // percentage
    this.opts.volumeThreshold = opts.volumeThreshold || 5 // 超过这个量的请求数量，bucket 数据才有意义
&nbsp;
    this._buckets = [createBucket()]
&nbsp;
    // 启动轮询
    this._state = createState(this.opts)
    this._ticker = startTicker(this._buckets, this.opts, this._state)
    this._executeCommand = stateExecuteCommand(this._state, this.opts.timeoutDuration)
  }
  run (command, fallback) {
    const curBucket = this._buckets[this._buckets.length - 1]
    if (!this._state.isOpen()) {
      // 非关闭状态，执行请求，并将其执行状况记录到最后一个 bucket 里
      return this._executeCommand(command, this._buckets)
    }
    fallback &amp;&amp; fallback()
    curBucket.shortCircuits++
    throw new Error('请求失败')
  }
  isOpen () {
    return this._state.isOpen()
  }
}
&nbsp;
module.exports = Hystrix
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Wed Nov 29 2017 18:05:24 GMT+0800 (CST)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
